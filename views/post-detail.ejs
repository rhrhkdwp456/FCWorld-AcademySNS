<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC월드</title>
    <link href="/main.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>



<body class="grey-bg">
    <%- include('nav-back.ejs') %>

    <div class="detail-bg">
        <div class="detail-box">
            <% if(JSON.stringify(result.user)  == JSON.stringify(user._id)){ %>
                <% if(JSON.stringify(user.authority) == JSON.stringify("MANAGER")){ %>
                    <div style="margin-bottom: 30px;">
                        <h4 style="font-weight: bold;"><%= result.title %></h4>
                        <p style="font-weight:800"><%= result.content %></p>
                    </div>
                    <img src="<%= result.img %>" onerror="this.style.display='none'">
                    <hr style="margin-top: 60px">
                    <div class="like-box">
                        <span><%= result.like %>명이 좋아합니다.</span>
                        <form class="like" action="/post/like" method="POST">
                          <input name= "id" value="<%= result._id %>" style="display: none;">
                          <button type="submit" class="like-btn">좋아요</button>
                        </form> 
                    </div>
                    <h5 style="font-weight: bold;">댓글 <%= comment.length %>개</h5>
                    <% for(let i =0; i< comment.length;i++){ %>
                        <div>   
                            <p><strong><%= comment[i].writer %></strong> <%= comment[i].comment %><span class="delete" data-id="<%= comment[i]._id %>">🗑️</span></p>
                            
                        </div>
                    <% } %>
                    <div class="post-chat-box">
                        <form class="d-flex align-items-start" action="/post/comment" method="POST">
                            <input class="chat-content1 form-control me-1" name="content" required>
                            <input name="parentId" value="<%= result._id %>" type="hidden">
                            <button class="btn btn-primary flex-shrink-0" type="submit">댓글작성</button>
                        </form>
                    </div>
                <% } else { %>
                    <div style="margin-bottom: 30px;">
                        <h4 style="font-weight: bold;"><%= result.title %></h4>
                        <p style="font-weight:800"><%= result.content %></p>
                    </div>
                    <img src="<%= result.img %>" onerror="this.style.display='none'">
                    <hr style="margin-top: 60px">
                    <div class="like-box">
                        <span><%= result.like %>명이 좋아합니다.</span>
                        <form class="like" action="/post/like" method="POST">
                          <input name= "id" value="<%= result._id %>" style="display: none;">
                          <button type="submit" class="like-btn">좋아요</button>
                        </form> 
                    </div>
                    <h5 style="font-weight: bold;">댓글 <%= comment.length %>개</h5>
                    <% for(let i =0; i< comment.length;i++){ %>
                        <div>   
                            <p><strong><%= comment[i].writer %></strong> <%= comment[i].comment %></p>
                        </div>
                    <% } %>
                    <div class="post-chat-box">
                        <form class="d-flex align-items-start" action="/post/comment" method="POST">
                            <input class="chat-content1 form-control me-1" name="content" required>
                            <input name="parentId" value="<%= result._id %>" type="hidden">
                            <button class="btn btn-primary flex-shrink-0" type="submit">댓글작성</button>
                        </form>
                    </div>
                <% } %>
            <% } else{ %>
                <% if(JSON.stringify(user.authority) == JSON.stringify("MANAGER")){ %>
                    <div style="margin-bottom: 30px;">
                        <h4 style="font-weight: bold;"><%= result.title %></h4>
                        <p style="font-weight:800"><%= result.content %></p>
                        <a href="/make-chat?writerId=<%= result.user %>" style="text-decoration: none; color: #2978B5; font-weight: bold; font-size: 20px;">채팅하기</a><br>
                    </div>
                    <img src="<%= result.img %>" onerror="this.style.display='none'">
                    <hr style="margin-top: 60px">
                    <div class="like-box">
                        <span><%= result.like %>명이 좋아합니다.</span>
                        <form class="like" action="/post/like" method="POST">
                          <input name= "id" value="<%= result._id %>" style="display: none;">
                          <button type="submit" class="like-btn">좋아요</button>
                        </form> 
                    </div>
                    <h5 style="font-weight: bold;">댓글 <%= comment.length %>개</h5>
                    <% for(let i =0; i< comment.length;i++){ %>
                        <div>   
                            <p><strong><%= comment[i].writer %></strong> <%= comment[i].comment %><span class="delete" data-id="<%= comment[i]._id %>">🗑️</span></p>
                        </div>
                    <% } %>
                    <div class="post-chat-box">
                        <form class="d-flex align-items-start" action="/post/comment" method="POST">
                            <input class="chat-content1 form-control me-1" name="content" required>
                            <input name="parentId" value="<%= result._id %>" type="hidden">
                            <button class="btn btn-primary flex-shrink-0" type="submit">댓글작성</button>
                        </form>
                    </div>
                <% } else { %>
                    <div style="margin-bottom: 30px;">
                        <h4 style="font-weight: bold;"><%= result.title %></h4>
                        <p style="font-weight:800"><%= result.content %></p>
                        <a href="/make-chat?writerId=<%= result.user %>" style="text-decoration: none; color: #2978B5; font-weight: bold; font-size: 20px;">채팅하기</a><br>
                    </div>
                    <img src="<%= result.img %>" onerror="this.style.display='none'">
                    <hr style="margin-top: 60px">
                    <div class="like-box">
                        <span><%= result.like %>명이 좋아합니다.</span>
                        <form class="like" action="/post/like" method="POST">
                          <input name= "id" value="<%= result._id %>" style="display: none;">
                          <button type="submit" class="like-btn">좋아요</button>
                        </form> 
                    </div>
                    <h5 style="font-weight: bold;">댓글 <%= comment.length %>개</h5>
                    <% for(let i =0; i< comment.length;i++){ %>
                        <div>   
                            <p><strong><%= comment[i].writer %></strong> <%= comment[i].comment %></p>
                        </div>
                    <% } %>
                    <div class="post-chat-box">
                        <form class="d-flex align-items-start" action="/post/comment" method="POST">
                            <input class="chat-content1 form-control me-1" name="content" required>
                            <input name="parentId" value="<%= result._id %>" type="hidden">
                            <button class="btn btn-primary flex-shrink-0" type="submit">댓글작성</button>
                        </form>
                    </div>
                <% } %>
            <% } %>
                
        </div>
        
        
    </div>  
    <script>
        var i;
        var totalDelete = document.querySelectorAll('.delete').length;
        for( i = 0;i < totalDelete  ; i++){
          document.querySelectorAll('.delete')[i].addEventListener('click', function(e){
            if(confirm('작성한 글을 삭제하시겠습니까?')){
              alert("정상적으로 삭제되었습니다.");
              fetch('/comment/delete?docid=' + e.target.dataset.id, {
                method : 'DELETE',
              })
              .then((r)=> r.text()) 
                // 서버가 보내는게 문자일 경우 r.text, array나 오브젝트 보내는 경우는 r.json적으면 됨.
              .then((r)=> {
                console.log("delete sucess")
                e.target.parentElement.parentElement.style.display ="none" 
                location.reload();
              })
            } 
        }
      )}
      </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>